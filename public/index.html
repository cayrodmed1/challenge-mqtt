<html>
  <head>
    <!-- vendor css -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css">
    <style media="screen">
      body, html {
        font-family: sans-serif;
      }
    </style>
  </head>
  <body>

    <h2>Netbeast developer challenge</h2>
    <h2>There is a MQTT over Websockets (HTTP) server running on port 8000</h2>

    <!-- vendor scripts -->
    <script src="//code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
    <script src="/mosca/mqtt.js"></script>

    <script>
      var client = mqtt.connect()

      client.subscribe("mqtt/demo")

      client.on("message", function(topic, payload) {
        // Comprobamos si existe
        if (!("Notification" in window)) {
          // Si no existe lo mandamos con toaster
          toastr.info([topic, payload].join(": "));
        }
        // Si existe...
        else if (Notification.permission === "granted") { // y tiene permiso
          // Creamos la notificación
          var options = {
            body: payload
          }
          var notification = new Notification(topic,options);
        }
        else if (Notification.permission !== 'denied') { // pero no tiene permiso
          // Pedimos permiso
          Notification.requestPermission(function (permission) {
            // Si el usuario acepta, creamos notificación
            if (permission === "granted") {
              var options = {
                body: payload
              }
              var notification = new Notification(topic,options);
            }
            // Si no nos da permiso, mandamos con toaster
            else
              toastr.info([topic, payload].join(": "));
          });
        }
      });

    client.publish("mqtt/demo", "Notificación enviada");
    </script>
  </body>
</html>
